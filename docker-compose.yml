services:
  n8n:
    build: .
    container_name: n8n_runner
    ports:
      - "5678:5678"
    command: ["execute-server"]
    environment:
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Asia/Bangkok}
      - NODE_ENV=${NODE_ENV:-production}
      - SUPABASE_API_KEY=${SUPABASE_API_KEY}
      - N8N_HOST=0.0.0.0
      - N8N_LISTEN_ADDRESS=0.0.0.0 
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_FEATURE_FLAG_DATA_TABLES=true

    volumes:
      - n8n_data:/home/node/.n8n
      - ./credentials:/opt/n8n/credentials
      - ./workflows:/opt/n8n/workflows
  # Batch Job Simulation (Cloud Run emulation)
  # Run this service to test the "daily execute" logic:
  # docker compose run --rm n8n-batch
  n8n-batch:
    build: .
    container_name: n8n_batch_job
    command: |
        /bin/sh -c "
        echo 'üîÑ Importing Credentials...'
        if [ -d /opt/n8n/credentials ]; then n8n import:credentials --separate --input=/opt/n8n/credentials/; fi;

        echo 'üì¶ Importing Workflows...'
        echo 'üì¶ Public Workflows...';
        n8n publish:workflow  --id="3Tz9JuKqVmNhUsC5";
        n8n publish:workflow  --id="36L_zFrISXUXJFlxYeTM-";
        n8n publish:workflow  --id=aUoOlwBznCRes9YK;
        n8n publish:workflow  --id=IYRdfkLhYI1x2Ak6;
        n8n publish:workflow  --id=QdSzSZGJP2tKve8P;
        n8n publish:workflow  --id=sCQjttZHaqnrujAG;
        n8n publish:workflow  --id=Se9kkEzLIOGZOb50;
        n8n publish:workflow  --id=VgUuzSEcrYCHVF1vd6dVN;
        n8n publish:workflow  --id=xswkRPME4gL2nleT;
        n8n publish:workflow  --id=blH4XGo5lXN4LQCrPHwHF
        echo 'üöÄ Starting n8n Server...';
        n8n start > /home/node/.n8n/n8n.log 2>&1 &
        N8N_PID=$$!
        sleep 10;
        echo '‚è≥ Waiting for n8n to be ready...'
        count=0
        until wget -q --spider http://127.0.0.1:5678/healthz || [ $$count -gt 60 ]; do 
          echo '...aligning satellites'
          sleep 2
          count=$$((count+1))
        done

        if [ $$count -gt 60 ]; then
          echo '‚ùå Timeout: Server did not start.'
          cat /home/node/.n8n/n8n.log
          exit 1
        fi
        
        echo '‚úÖ n8n is Online!'
        echo 'üî• Triggering Batch Job...'

        http_status_code=$$(curl -m 3600 --write-out '%{http_code}'  --fail-with-body -o /tmp/response.json http://127.0.0.1:5678/webhook/batch)
        RESPONSE_STATUS=$$(jq -r '.status' /tmp/response.json)
        echo \"üîç Debug: API returned status -> '$${RESPONSE_STATUS}'  '$${http_status_code}'\"
        cat /tmp/response.json
        if [ \"$$RESPONSE_STATUS\" == "success" ]; then
            echo '‚úÖ Validation Passed: Status is success.'
            echo /tmp/response.json | jq .
        else
            echo \"‚ùå Workflow Failed: Expected status \"success\" but got '$${RESPONSE_STATUS}'-'$${http_status_code}'\"
            echo 'dumping full response for debugging:'
            cat /tmp/response.json
            exit 1
        fi
              
        echo 'üõë Batch process finished. Stopping n8n...'
        kill $$N8N_PID
        wait $$N8N_PID  
        echo 'üëã Done.'
        exit 0
        "
    environment:
      - N8N_LOG_OUTPUT=console,file
      - N8N_LOG_LEVEL=info
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Asia/Bangkok}
      - SUPABASE_API_KEY=${SUPABASE_API_KEY}
      - N8N_FEATURE_FLAG_DATA_TABLES=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
    volumes:
      # Ephemeral data for batch job (simulates Cloud Run)
      - n8n_data:/home/node/.n8n
      - ./credentials:/opt/n8n/credentials
      - ./workflows:/opt/n8n/workflows
      - ./result.log:/home/node/.n8n/n8n.log
  n8n-curl:
    build: .
    container_name: n8n_batch_job
    command: ["execute-curl"]
    
    environment:
      - N8N_LOG_OUTPUT=console,file
      - N8N_LOG_LEVEL=info
      - N8N_LOG_FILE_LOCATION=/home/node/.n8n/n8n.log
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Asia/Bangkok}
      - SUPABASE_API_KEY=${SUPABASE_API_KEY}
      - N8N_FEATURE_FLAG_DATA_TABLES=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
    volumes:
      # Ephemeral data for batch job (simulates Cloud Run)
      - n8n_data:/home/node/.n8n
      - ./credentials:/opt/n8n/credentials
      - ./workflows:/opt/n8n/workflows
      - ./result.log:/home/node/.n8n/n8n.log
volumes:
  n8n_data:
